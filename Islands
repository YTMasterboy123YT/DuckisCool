local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local backpack = LocalPlayer:WaitForChild("Backpack")

-- Whitelist table
local whitelistedPlayers = {}

-- Set fast attack speed
local function setToolAttributes(toolName, attributeType, value)
    local tool = backpack:FindFirstChild(toolName)
    if tool then
        tool[attributeType].Value = value
    end
end

local toolsToSet = {
    {"Punch", "attackTime", 0.1},
}

for _, toolData in ipairs(toolsToSet) do
    setToolAttributes(unpack(toolData))
end

-- Auto hit function
local function autoHit()
    LocalPlayer.muscleEvent:FireServer("punch", "leftHand")
    LocalPlayer.muscleEvent:FireServer("punch", "rightHand")
end

-- Friend check function
local function isFriend(player)
    return player:IsFriendsWith(LocalPlayer.UserId)
end

-- Create window
local Window = Fluent:CreateWindow({
    Title = "Head Controller",
    SubTitle = "by Cody",
    TabWidth = 160,
    Size = UDim2.new(0, 400, 0, 300),
    Acrylic = true,
    Theme = "Dark"
})

local Tab = Window:AddTab({ Title = "Main", Icon = "rbxassetid://12345678" })
local isRunning = false

-- Add whitelist input
local Input = Tab:AddInput("WhitelistInput", {
    Title = "Whitelist Player",
    Default = "",
    Placeholder = "Enter player name",
    Callback = function(text)
        for _, player in ipairs(Players:GetPlayers()) do
            if player.Name:lower() == text:lower() then
                table.insert(whitelistedPlayers, player.Name)
                Fluent:Notify({
                    Title = "Success",
                    Content = player.Name .. " has been whitelisted",
                    Duration = 3
                })
                return
            end
        end
    end
})

-- Add unwhitelist input
local UnwhitelistInput = Tab:AddInput("UnwhitelistInput", {
    Title = "Unwhitelist Player",
    Default = "",
    Placeholder = "Enter player name to unwhitelist",
    Callback = function(text)
        for i, name in ipairs(whitelistedPlayers) do
            if name:lower() == text:lower() then
                table.remove(whitelistedPlayers, i)
                Fluent:Notify({
                    Title = "Success",
                    Content = name .. " has been unwhitelisted",
                    Duration = 3
                })
                return
            end
        end
    end
})

-- Toggle button with enhanced functionality
local Toggle = Tab:AddToggle("ToggleHead", {
    Title = "Toggle Head Control",
    Default = false,
    Callback = function(value)
        isRunning = value
        if isRunning then
            spawn(function()
                while isRunning do
                    local character = LocalPlayer.Character
                    if character then
                        local rightHand = character:FindFirstChild("Right Hand") or character:FindFirstChild("RightHand")
                        if rightHand then
                            -- Auto equip punch
                            local punchTool = backpack:FindFirstChild("Punch")
                            if punchTool and not character:FindFirstChild("Punch") then
                                punchTool.Parent = character
                            end
                            
                            for _, player in ipairs(Players:GetPlayers()) do
                                if player ~= LocalPlayer and 
                                   not table.find(whitelistedPlayers, player.Name) and 
                                   not isFriend(player) then
                                    local playerChar = player.Character
                                    if playerChar then
                                        local head = playerChar:FindFirstChild("Head")
                                        if head then
                                            head.Transparency = 1
                                            head.CFrame = rightHand.CFrame
                                            autoHit()
                                        end
                                    end
                                end
                            end
                        end
                    end
                    task.wait()
                end
            end)
        end
    end
})

-- Show friends list button
local FriendsButton = Tab:AddButton({
    Title = "Show Protected Friends",
    Callback = function()
        local friendsList = {}
        for _, player in ipairs(Players:GetPlayers()) do
            if isFriend(player) then
                table.insert(friendsList, player.Name)
            end
        end
        Fluent:Notify({
            Title = "Protected Friends Online",
            Content = #friendsList > 0 and table.concat(friendsList, ", ") or "No friends online",
            Duration = 5
        })
    end
})

-- Clear whitelist button
local Button = Tab:AddButton({
    Title = "Clear Whitelist",
    Callback = function()
        table.clear(whitelistedPlayers)
        Fluent:Notify({
            Title = "Success",
            Content = "Whitelist cleared",
            Duration = 3
        })
    end
})

-- Show whitelisted players
local Button2 = Tab:AddButton({
    Title = "Show Whitelisted Players",
    Callback = function()
        local playerList = table.concat(whitelistedPlayers, ", ")
        Fluent:Notify({
            Title = "Whitelisted Players",
            Content = playerList ~= "" and playerList or "No players whitelisted",
            Duration = 5
        })
    end
})

-- Initial notification
Fluent:Notify({
    Title = "Script Loaded",
    Content = "Friend Protection Active | Fast Attack Enabled",
    Duration = 5
})
